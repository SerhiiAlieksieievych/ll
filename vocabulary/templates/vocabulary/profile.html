{% extends 'base.html' %}
{% block content %}
{% load widget_tweaks %}

<style>
    /* –ê–Ω—ñ–º–∞—Ü—ñ—è –ø–æ—è–≤–∏ –≤—Å—ñ—î—ó —Å—Ç–æ—Ä—ñ–Ω–∫–∏ –ø—ñ—Å–ª—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è/–∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è */
    .page-load-fade {
        animation: fadeInPage 0.5s ease-out;
    }

    @keyframes fadeInPage {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Å—Ç–∞–±—ñ–ª—ñ–∑–∞—Ü—ñ—ó –≤–∏—Å–æ—Ç–∏ */
    .profile-card-container {
        position: relative;
        min-height: 380px;
    }

    /* –ë–∞–∑–æ–≤–∏–π —Å—Ç–∞–Ω –¥–ª—è –∞–Ω—ñ–º–∞—Ü—ñ—ó –±–ª–æ–∫—ñ–≤ */
    .fade-section {
        transition: opacity 0.2s ease-out, transform 0.2s ease-out;
        opacity: 1;
        transform: scale(1);
    }

    /* –°—Ç–∞–Ω –ø—Ä–∏—Ö–æ–≤–∞–Ω–æ–≥–æ –±–ª–æ–∫—É */
    .fade-hidden {
        opacity: 0;
        transform: scale(0.98);
        display: none !important;
    }

    /* –°—Ç–∏–ª—å –¥–ª—è –∫–Ω–æ–ø–∫–∏, —â–æ –∑–∞–≤–∞–Ω—Ç–∞–∂—É—î—Ç—å—Å—è */
    .btn-loading {
        pointer-events: none;
        opacity: 0.7;
    }
</style>

{% if messages %}
    {% for message in messages %}
        <div class="alert alert-success alert-dismissible fade show page-load-fade" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    {% endfor %}
{% endif %}

<div class="row page-load-fade">
    <div class="col-md-4">
        <div class="card shadow-sm mb-4 border-0">
            <div class="card-body text-center profile-card-container">

                <div class="mb-3">
                    {% if user.profile.avatar %}
                        <img id="avatar-preview" src="{{ user.profile.avatar.url }}" class="rounded-circle img-thumbnail" style="width: 150px; height: 150px; object-fit: cover;">
                    {% else %}
                        <img id="avatar-preview" src="https://ui-avatars.com/api/?name={{ user.username }}&size=150" class="rounded-circle mb-3" style="width: 150px; height: 150px; object-fit: cover;">
                    {% endif %}
                </div>

                <div id="profile-view-section" class="fade-section">
                    <h4 class="mb-1">{{ user.username }}</h4>
                    <p class="text-muted small mb-2">{{ user.email }}</p>
                    <span class="badge bg-light text-dark border mb-3">{{ user.profile.get_english_level_display }}</span>
                    <button onclick="toggleEdit()" class="btn btn-sm btn-primary w-100">–†–µ–¥–∞–≥—É–≤–∞—Ç–∏ –ø—Ä–æ—Ñ—ñ–ª—å</button>
                </div>

                <div id="profile-edit-section" class="fade-section fade-hidden" style="opacity: 0;">
                    <form method="post" enctype="multipart/form-data" id="profile-form">
                        {% csrf_token %}
                        <div class="text-start">
                            <div class="mb-2">
                                <label class="small fw-bold">–ù—ñ–∫–Ω–µ–π–º:</label>
                                {% render_field u_form.username class="form-control form-control-sm" %}
                            </div>
                            <div class="mb-2">
                                <label class="small fw-bold">Email:</label>
                                {% render_field u_form.email class="form-control form-control-sm" %}
                            </div>
                            <div class="mb-3">
                                <label class="small fw-bold">–†—ñ–≤–µ–Ω—å:</label>
                                {% render_field p_form.english_level class="form-select form-select-sm" %}
                            </div>

                            <div class="p-2 border rounded bg-light mb-3">
                                <label class="small fw-bold d-block mb-1">–ó–º—ñ–Ω–∏—Ç–∏ —Ñ–æ—Ç–æ:</label>
                                <input type="file" name="avatar" accept="image/*" class="form-control form-control-sm" id="avatar-input">

                                {% if user.profile.avatar %}
                                <div class="form-check mt-2">
                                    <input type="checkbox" name="avatar-clear" id="avatar-clear_id" class="form-check-input">
                                    <label class="form-check-label small text-danger" for="avatar-clear_id">
                                        üóëÔ∏è –í–∏–¥–∞–ª–∏—Ç–∏ —Ñ–æ—Ç–æ
                                    </label>
                                </div>
                                {% endif %}
                            </div>
                        </div>

                        <div class="mb-3">
                            <a href="{% url 'password_change' %}" class="btn btn-sm btn-outline-danger w-100">–ó–º—ñ–Ω–∏—Ç–∏ –ø–∞—Ä–æ–ª—å</a>
                        </div>

                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-sm btn-success flex-grow-1" id="save-btn">–ó–±–µ—Ä–µ–≥—Ç–∏</button>
                            <button type="button" onclick="cancelEdit()" class="btn btn-sm btn-outline-secondary flex-grow-1">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-8">
        <div class="row g-3 mb-4 text-center">
            <div class="col-4"><div class="p-3 bg-white border rounded shadow-sm"><h5>–¢–µ–∫—Å—Ç—ñ–≤</h5><p class="h2">{{ text_count }}</p></div></div>
            <div class="col-4"><div class="p-3 bg-white border rounded shadow-sm"><h5>–°–ª—ñ–≤</h5><p class="h2">{{ total_words }}</p></div></div>
            <div class="col-4"><div class="p-3 bg-white border rounded shadow-sm"><h5>–†—ñ–≤–µ–Ω—å</h5><p class="badge bg-info text-dark">{{ user.profile.get_english_level_display }}</p></div></div>
        </div>

        <h4 class="mb-3">üìö –û—Å—Ç–∞–Ω–Ω—ñ —Ç–µ–∫—Å—Ç–∏</h4>
        <ul class="list-group mb-4 shadow-sm">
            {% for text in last_texts %}
                <a href="{% url 'view_analysis' text.pk %}" class="list-group-item list-group-item-action d-flex justify-content-between">
                    {{ text.title }} <small class="text-muted">{{ text.created_at|date:"d.m" }}</small>
                </a>
            {% empty %}
                <li class="list-group-item">–¢–µ–∫—Å—Ç—ñ–≤ —â–µ –Ω–µ–º–∞—î</li>
            {% endfor %}
        </ul>

        <h4 class="mb-3">üß† –°–ª–æ–≤–∞, —â–æ –≤–∏–≤—á–∞—é—Ç—å—Å—è</h4>
        <div class="d-flex flex-wrap gap-2 mb-4">
            {% for word in learning_words %}
                <span class="badge bg-warning text-dark p-2 fs-6 shadow-sm">
                    {{ word.english_word }} ‚Üí {{ word.ukrainian_translation }}
                </span>
            {% empty %}
                <p class="text-muted">–í—Å—ñ —Å–ª–æ–≤–∞ –≤–∏–≤—á–µ–Ω—ñ! üí™</p>
            {% endfor %}
        </div>
    </div>
</div>

<script>
    const avatarInput = document.getElementById('avatar-input');
    const avatarPreview = document.getElementById('avatar-preview');
    const originalAvatarSrc = avatarPreview.src;
    const saveBtn = document.getElementById('save-btn');
    const profileForm = document.getElementById('profile-form');

    // –ü—Ä–µ–≤'—é —Ñ–æ—Ç–æ
    avatarInput.onchange = function() {
        const [file] = avatarInput.files;
        if (file) {
            avatarPreview.src = URL.createObjectURL(file);
        }
    };

    // –ü–ª–∞–≤–Ω–µ –ø–µ—Ä–µ–º–∏–∫–∞–Ω–Ω—è –Ω–∞ —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è
    function toggleEdit() {
        const view = document.getElementById('profile-view-section');
        const edit = document.getElementById('profile-edit-section');

        view.style.opacity = '0';
        view.style.transform = 'scale(0.98)';

        setTimeout(() => {
            view.classList.add('fade-hidden');
            edit.classList.remove('fade-hidden');
            setTimeout(() => {
                edit.style.opacity = '1';
                edit.style.transform = 'scale(1)';
            }, 10);
        }, 200);
    }

    // –°–∫–∞—Å—É–≤–∞–Ω–Ω—è —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è
    function cancelEdit() {
        const view = document.getElementById('profile-view-section');
        const edit = document.getElementById('profile-edit-section');

        edit.style.opacity = '0';
        edit.style.transform = 'scale(0.98)';

        setTimeout(() => {
            edit.classList.add('fade-hidden');
            view.classList.remove('fade-hidden');
            setTimeout(() => {
                view.style.opacity = '1';
                view.style.transform = 'scale(1)';
            }, 10);

            // –°–∫–∏–¥–∞–Ω–Ω—è –∑–º—ñ–Ω
            avatarPreview.src = originalAvatarSrc;
            avatarInput.value = "";
            const clearCheck = document.getElementById('avatar-clear_id');
            if (clearCheck) clearCheck.checked = false;
        }, 200);
    }

    // –û–±—Ä–æ–±–∫–∞ –Ω–∞—Ç–∏—Å–∫–∞–Ω–Ω—è "–ó–±–µ—Ä–µ–≥—Ç–∏"
    profileForm.onsubmit = function() {
        saveBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> –ó–±–µ—Ä—ñ–≥–∞—é...';
        saveBtn.classList.add('btn-loading');
    };
</script>

{% endblock %}